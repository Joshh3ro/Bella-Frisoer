@* 
  Create.razor
  Purpose: Blazor page to create a new Booking.
  The comments explain each directive, markup block and code member.
*@

@* Route for the page: component is accessible at /bookings/create *@
@page "/bookings/opret"

@* Bring EF Core asynchronous query extensions (ToListAsync, OrderBy, Include) into scope *@
@using Microsoft.EntityFrameworkCore
@using System.Globalization

@* Provide Blazor form components like EditForm, InputText, InputSelect, ValidationMessage *@
@using Microsoft.AspNetCore.Components.Forms

@* Domain model types used on this page: Booking, Customer, Employee *@
@using BellaFrisoer.Domain.Models

@using BellaFrisoer.Application.Interfaces

@inject IBookingConflictChecker BookingConflictChecker
@inject IBookingService BookingService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject ITreatmentService TreatmentService

@inject NavigationManager NavigationManager



@* Render mode for Blazor Server with interactive prerendering (keeps component interactive) *@
@rendermode InteractiveServer

@* Sets the browser title while this page is active *@
<PageTitle>Opret Booking</PageTitle>

@* Page heading shown to users *@
<h1>Opret Booking</h1>

@* Show a persistent error area when ErrorMessage is set in the component state *@
@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger" role="alert">@ErrorMessage</div>
}

@* Show a loading indicator while we fetch customers (customers is null until loaded) *@
@if (customers == null)
{
    <p><em>Loading...</em></p>
}
else
{
    @* Main form binding to the Booking instance.
       - Model: the object bound to inputs and validated by DataAnnotations
       - OnValidSubmit: handler when validation passes
       - OnInvalidSubmit: handler when validation fails *@
    <EditForm Model="Booking" OnValidSubmit="AddBooking" OnInvalidSubmit="OnInvalidSubmit" FormName="BookingForm">
        @* Enables data-annotation validation on the model *@
        <DataAnnotationsValidator />
        @* Displays a summary of validation errors *@
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Booking Dato</label>
            <InputDate @bind-Value="Booking.BookingDate" class="form-control" />
            <ValidationMessage For="@(() => Booking.BookingDate)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Booking starttidspunkt</label>
            <InputText @bind-Value="bookingStartTimeString" class="form-control" type="time" />
            <ValidationMessage For="@(() => Booking.BookingStartTime)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Booking varighed</label>
            @* Display-only field showing current Booking duration *@
            <div class="form-control-plaintext">@DurationDisplay</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Booking pris</label>
            <div class="form-control-plaintext">@PriceDisplay</div>
        </div>

        <div class="mb-3">
	        <label class="form-label">Kunde</label>
	        @if (!customers.Any())
	        {
		        <div>
			        <p>Ingen kunder endnu... <a href="/kunder/opret">Opret Kunde</a></p>
		        </div>
	        }
	        else
	        {
		        <InputSelect @bind-Value="Booking.CustomerId" class="form-select">
			        <option value="0">-- Vælg Kunde --</option>
			        @foreach (var c in customers)
			        {
				        <option value="@c.Id">@c.FirstName (@(c.PhoneNumber.ToString() ?? "Intet tlf nummer..."))</option>
			        }
		        </InputSelect>
		        <ValidationMessage For="@(() => Booking.CustomerId)" />
	        }
        </div>

        <div class="mb-3">
	        <label class="form-label">Ansatte</label>
	        @if (employees == null || !employees.Any())
	        {
		        <div>
			        <p>Ingen registrerede ansatte... <a href="/customers/create">Opret Ansat</a></p>
		        </div>
	        }
	        else
	        {
		        <InputSelect @bind-Value="SelectedEmployeeId" class="form-select">
            <option value="0"> -- Vælg Ansat --</option>
            @foreach (var e in employees)
            {
                <option value="@e.Id">@e.FirstName (@(e.PhoneNumber.ToString() ?? "Intet tlf nummer..."))</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => Booking.EmployeeId)" />
	        }
        </div>

        <div class="mb-3">
            <label class="form-label">Behandling</label>
            @if (treatments == null || !treatments.Any())
            {
                <div>
                    <p>Ingen registrerede ansatte... <a href="/customers/create">Opret Ansat</a></p>
                </div>
            }
            else
            {
                @* Bind to SelectedTreatmentId so the setter runs when selection changes *@
                <InputSelect @bind-Value="SelectedTreatmentId" class="form-select">
                    <option value="0"> -- Vælg behandling --</option>
                    @foreach (var t in treatments)
                    {
                        <option value="@t.Id">@t.Name </option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => Booking.TreatmentId)" />
            }
        </div>

        <button class="btn btn-primary" type="submit" disabled="@(!customers.Any())">Opret</button>
        <a class="btn btn-link" href="/kunder/opret">Opret kunde</a>
    </EditForm>
}

@code {
    private Booking Booking { get; set; } = new Booking { BookingDate = DateTime.Now, CustomerId = 0 };
    private string bookingStartTimeString = "";
    private string BookingDurationString = "";

    private List<Customer>? customers;
    private List<Employee>? employees;
    private List<Treatment>? treatments;
    private string? ErrorMessage;

    // Backing field and property to run logic when treatment selection changes
    private int selectedTreatmentId;
    private int SelectedTreatmentId
    {
        get => selectedTreatmentId;
        set
        {
            if (selectedTreatmentId == value) return;
            selectedTreatmentId = value;
            // Update the Booking model and the displayed duration
            Booking.TreatmentId = value;
            UpdateDurationFromTreatment(value);
        }
    }

    // Backing field and property to run logic when employee selection changes
    private int selectedEmployeeId;
    private int SelectedEmployeeId
    {
        get => selectedEmployeeId;
        set
        {
            if (selectedEmployeeId == value) return;
            selectedEmployeeId = value;
            Booking.EmployeeId = value;
            // Recompute price using current treatment/duration + employee
            UpdatePrice();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            treatments = (await TreatmentService.GetAllAsync()).OrderBy(t => t.Name).ToList();
            customers = (await CustomerService.GetAllAsync()).OrderBy(c => c.FirstName).ToList();
            employees = (await EmployeeService.GetAllAsync()).OrderBy(e => e.LastName).ToList();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Load failed: {ex.Message}";
        }
    }

    private void OnInvalidSubmit(EditContext ctx)
    {
        ErrorMessage = "Form is invalid. Please fix validation errors.";
    }

    private async Task AddBooking()
    {
        ErrorMessage = null;

        // Parse the time string to TimeOnly
        if (!TimeOnly.TryParse(bookingStartTimeString, out var startTime))
        {
            ErrorMessage = "Ugyldigt starttidspunkt.";
            return;
        }
        Booking.BookingStartTime = startTime;

        // Use the Booking.BookingDuration directly (BookingDurationString is kept for compatibility)
        if (Booking.BookingDuration == default || Booking.BookingDuration <= TimeSpan.Zero)
        {
            // fallback: attempt to parse textual representation
            if (!TimeSpan.TryParse(BookingDurationString, out var duration))
            {
                ErrorMessage = "Ugyldig varighed.";
                return;
            }
            Booking.BookingDuration = duration;
        }

        if (Booking.CustomerId <= 0)
        {
            ErrorMessage = "Vælg kunde...";
            return;
        }

        if (Booking.EmployeeId <= 0)
        {
            ErrorMessage = "Vælg ansat...";
            return;
        }

        if (Booking.TreatmentId <= 0)
        {
            ErrorMessage = "Vælg behandling...";
            return;

        }

        if (Booking.BookingStartTime == default)
        {
            ErrorMessage = "Ugyldigt starttidspunkt.";
            return;
        }
        if (Booking.BookingDuration == default || Booking.BookingDuration <= TimeSpan.Zero)
        {
            ErrorMessage = "Ugyldig varighed.";
            return;
        }

        var canCreate = await BookingService.CanCreateBookingAsync(Booking);
        if (!canCreate)
        {
            ErrorMessage = "Booking conflict: selected customer or employee already has a booking during this time.";
            return;
        }

        try
        {
            await BookingService.AddBookingAsync(Booking);
            NavigationManager.NavigateTo("/bookings");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Save failed: {ex.Message}";
        }

    }

    // Sets the duration to the treatment duration (avoids accumulating on repeated selection)
    private void UpdateDurationFromTreatment(int treatmentId)
    {
        if (treatmentId <= 0)
        {
            Booking.BookingDuration = TimeSpan.Zero;
            BookingDurationString = string.Empty;
            // Recompute price (will fall back to 0)
            UpdatePrice();
            StateHasChanged();
            return;
        }

        var treatment = treatments?.FirstOrDefault(t => t.Id == treatmentId);
        if (treatment == null)
        {
            Booking.BookingDuration = TimeSpan.Zero;
            BookingDurationString = string.Empty;
            UpdatePrice();
            StateHasChanged();
            return;
        }

        // Set duration to the treatment duration (avoid accumulating on repeated selection)
        Booking.BookingDuration = TimeSpan.FromMinutes(treatment.Duration);
        BookingDurationString = Booking.BookingDuration.ToString(@"hh\:mm");

        // Recompute price now that treatment (and duration) changed
        UpdatePrice();

        StateHasChanged();
    }

    // Compute the price using the most appropriate source:
    // - Use Treatment.Price as base when available
    // - Always add an employee hourly component if an employee + duration are present
    // - Otherwise fall back to employee-only calculation or 0
    private void UpdatePrice()
    {
        decimal computedPrice = 0m;

        // Base price from treatment when available
        if (Booking.TreatmentId > 0)
        {
            var treatment = treatments?.FirstOrDefault(t => t.Id == Booking.TreatmentId);
            if (treatment != null && treatment.Price > 0m)
            {
                computedPrice = treatment.Price;
            }
        }

        // Add employee hourly component when we have both an employee and a duration
        if (Booking.EmployeeId > 0 && Booking.BookingDuration > TimeSpan.Zero)
        {
            var employee = employees?.FirstOrDefault(e => e.Id == Booking.EmployeeId);
            if (employee != null && employee.HourlyPrice > 0d)
            {
                var minutes = (decimal)Booking.BookingDuration.TotalMinutes;
                var employeePart = ((decimal)employee.HourlyPrice / 60m) * minutes;
                computedPrice += employeePart;
            }
        }

        Booking.TotalPrice = computedPrice;
        StateHasChanged();
    }

    // Display helper for the Booking duration (shows hh:mm, including 00:00)
    private string DurationDisplay =>
        Booking.BookingDuration >= TimeSpan.Zero
            ? Booking.BookingDuration.ToString(@"hh\:mm")
            : string.Empty;

    // Display helper for the Booking price (shows currency, including 0 kr)
    private string PriceDisplay =>
        Booking.TotalPrice >= 0m
            ? Booking.TotalPrice.ToString("C0", CultureInfo.GetCultureInfo("da-DK"))
            : string.Empty;
}
