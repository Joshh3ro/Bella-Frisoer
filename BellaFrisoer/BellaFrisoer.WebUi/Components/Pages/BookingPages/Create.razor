@page "/bookings/create"
@using Microsoft.EntityFrameworkCore
@using BellaFrisoer.Domain.Models
@inject IDbContextFactory<BellaFrisoer.WebUi.Data.BellaFrisoerWebUiContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Create Booking</PageTitle>

<h1>Create Booking</h1>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger" role="alert">@ErrorMessage</div>
}

@if (customers is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm Model="Booking" OnValidSubmit="AddBooking" OnInvalidSubmit="OnInvalidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Booking date/time</label>
            <InputDate @bind-Value="Booking.BookingDateTime" class="form-control" />
            <ValidationMessage For="() => Booking.BookingDateTime" />
        </div>

        <div class="mb-3">
            <label class="form-label">Customer</label>
            @if (!customers.Any())
            {
                <div>
                    <p>No customers yet. <a href="/customers/create">Create one</a> first.</p>
                </div>
            }
            else
            {
                <InputSelect @bind-Value="Booking.CustomerId" class="form-select">
                    <option value="0">-- select customer --</option>
                    @foreach (var c in customers)
                    {
                        <option value="@c.Id">@c.Name (@(c.PhoneNumber?.ToString() ?? "no phone"))</option>
                    }
                </InputSelect>
                <ValidationMessage For="() => Booking.CustomerId" />
            }
        </div>

        <button class="btn btn-primary" type="submit" disabled="@(!customers.Any())">Create</button>
        <a class="btn btn-link" href="/customers/create">Create customer</a>
    </EditForm>
}

@code {
    private Booking Booking { get; set; } = new Booking { BookingDateTime = DateTime.Now, CustomerId = 0 };
    private List<Customer> customers = new();
    private string? ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        using var ctx = DbFactory.CreateDbContext();
        customers = await ctx.Customers.OrderBy(c => c.Name).ToListAsync();
    }

    private void OnInvalidSubmit(EditContext ctx)
    {
        ErrorMessage = "Form is invalid. Please fix validation errors.";
    }

    private async Task AddBooking()
    {
        ErrorMessage = null;

        if (Booking.CustomerId == 0)
        {
            ErrorMessage = "Please select a customer.";
            return;
        }

        try
        {
            using var ctx = DbFactory.CreateDbContext();
            ctx.Bookings.Add(Booking);
            await ctx.SaveChangesAsync();
            NavigationManager.NavigateTo("/bookings", forceLoad: true);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Save failed: {ex.Message}";
        }
    }
}
