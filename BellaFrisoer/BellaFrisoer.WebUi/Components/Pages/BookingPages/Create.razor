@* 
  Create.razor
  Purpose: Blazor page to create a new Booking.
  The comments explain each directive, markup block and code member.
*@

@* Route for the page: component is accessible at /bookings/create *@
@page "/bookings/opret"

@* Bring EF Core asynchronous query extensions (ToListAsync, OrderBy, Include) into scope *@
@using Microsoft.EntityFrameworkCore
@using System.Globalization

@* Provide Blazor form components like EditForm, InputText, InputSelect, ValidationMessage *@
@using Microsoft.AspNetCore.Components.Forms

@* Domain model types used on this page: Booking, Customer, Employee *@
@using BellaFrisoer.Domain.Models

@using BellaFrisoer.Domain.Models.Discounts

@using BellaFrisoer.Application.Interfaces

@inject IBookingConflictChecker BookingConflictChecker
@inject IBookingService BookingService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject ITreatmentService TreatmentService

@inject NavigationManager NavigationManager



@* Render mode for Blazor Server with interactive prerendering (keeps component interactive) *@
@rendermode InteractiveServer

@* Sets the browser title while this page is active *@
<PageTitle>Opret Booking</PageTitle>

@* Page heading shown to users *@
<h1>Opret Booking</h1>

@* Show a persistent error area when ErrorMessage is set in the component state *@
@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger" role="alert">@ErrorMessage</div>
}

@* Show a loading indicator while we fetch customers (customers is null until loaded) *@
@if (customers == null)
{
    <p><em>Loading...</em></p>
}
else
{
    @* Main form binding to the Booking instance.
       - Model: the object bound to inputs and validated by DataAnnotations
       - OnValidSubmit: handler when validation passes
       - OnInvalidSubmit: handler when validation fails *@
    <EditForm Model="Booking" OnValidSubmit="AddBooking" OnInvalidSubmit="OnInvalidSubmit" FormName="BookingForm">
        @* Enables data-annotation validation on the model *@
        <DataAnnotationsValidator />
        @* Displays a summary of validation errors *@
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Booking Dato</label>
            <InputDate @bind-Value="Booking.BookingDate" class="form-control" />
            <ValidationMessage For="@(() => Booking.BookingDate)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Booking starttidspunkt</label>
            <InputText @bind-Value="bookingStartTimeString" class="form-control" type="time" />
            <ValidationMessage For="@(() => Booking.BookingStartTime)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Booking varighed</label>
            @* Display-only field showing current Booking duration *@
            <div class="form-control-plaintext">@DurationDisplay</div>
        </div>

        <div class="mb-3">
	        <label class="form-label">Kunde</label>
	        @if (!customers.Any())
	        {
		        <div>
			        <p>Ingen kunder endnu... <a href="/kunder/opret">Opret Kunde</a></p>
		        </div>
	        }
	        else
	        {
		        <InputSelect @bind-Value="Booking.CustomerId" class="form-select">
			        <option value="0">-- Vælg Kunde --</option>
			        @foreach (var c in customers)
			        {
				        <option value="@c.Id">@c.FirstName (@(c.PhoneNumber.ToString() ?? "Intet tlf nummer..."))</option>
			        }
		        </InputSelect>
		        <ValidationMessage For="@(() => Booking.CustomerId)" />
	        }
        </div>

        <div class="mb-3">
	        <label class="form-label">Ansatte</label>
	        @if (employees == null || !employees.Any())
	        {
		        <div>
			        <p>Ingen registrerede ansatte... <a href="/customers/create">Opret Ansat</a></p>
		        </div>
	        }
	        else
	        {
		        <InputSelect @bind-Value="SelectedEmployeeId" class="form-select">
            <option value="0"> -- Vælg Ansat --</option>
            @foreach (var e in employees)
            {
                <option value="@e.Id">@e.FirstName (@(e.PhoneNumber.ToString() ?? "Intet tlf nummer..."))</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => Booking.EmployeeId)" />
	        }
        </div>

        <div class="mb-3">
            <label class="form-label">Behandling</label>
            @if (treatments == null || !treatments.Any())
            {
                <div>
                    <p>Ingen registrerede ansatte... <a href="/customers/create">Opret Ansat</a></p>
                </div>
            }
            else
            {
                @* Bind to SelectedTreatmentId so the setter runs when selection changes *@
                <InputSelect @bind-Value="SelectedTreatmentId" class="form-select">
                    <option value="0"> -- Vælg behandling --</option>
                    @foreach (var t in treatments)
                    {
                        <option value="@t.Id">@t.Name </option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => Booking.TreatmentId)" />
            }
        </div>
        <div class="mb-3">
            <label class="form-label">Booking pris</label>
            <div class="form-control-plaintext">@PriceDisplay</div>
        </div>

        <fieldset class="border rounded p-3 mb-3">
            <legend class="float-none w-auto px-2 fs-6">Event rabat (dato og tid)</legend>
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" role="switch" id="evtEnabled" @bind="eventDiscountEnabled" @bind:after="UpdatePrice" />
                <label class="form-check-label" for="evtEnabled">Aktivér event rabat</label>
            </div>

            @if (eventDiscountEnabled)
            {
                <div class="row g-2 mb-2">
                    <div class="col-sm-6">
                        <label class="form-label">Start dato</label>
                        <InputDate @bind-Value="eventStartDate" @bind-Value:after="UpdatePrice" class="form-control" />
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label">Start tid</label>
                        <InputText @bind-Value="eventStartTimeString" @bind-Value:after="UpdatePrice" class="form-control" type="time" />
                    </div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-sm-6">
                        <label class="form-label">Slut dato</label>
                        <InputDate @bind-Value="eventEndDate" @bind-Value:after="UpdatePrice" class="form-control" />
                    </div>
                    <div class="col-sm-6">
                        <label class="form-label">Slut tid</label>
                        <InputText @bind-Value="eventEndTimeString" @bind-Value:after="UpdatePrice" class="form-control" type="time" />
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">Rabat i procent</label>
                    <InputNumber @bind-Value="eventDiscountPercent" @bind-Value:after="UpdatePrice" class="form-control" min="0" max="100" step="1" />
                    <div class="form-text">Angiv 10 for 10%.</div>
                </div>
                @if (!string.IsNullOrEmpty(eventValidationMessage))
                {
                    <div class="text-danger">@eventValidationMessage</div>
                }
            }
        </fieldset>
        <button class="btn btn-primary" type="submit" disabled="@(!customers.Any())">Opret</button>
    </EditForm>
}

@code {
    private Booking Booking { get; set; } = new Booking { BookingDate = DateTime.Now, CustomerId = 0 };
    private string bookingStartTimeString = "";
    private string BookingDurationString = "";

    private List<Customer>? customers;
    private List<Employee>? employees;
    private List<Treatment>? treatments;
    private string? ErrorMessage;

    // Backing field and property to run logic when treatment selection changes
    private int selectedTreatmentId;
    private int SelectedTreatmentId
    {
        get => selectedTreatmentId;
        set
        {
            if (selectedTreatmentId == value) return;
            selectedTreatmentId = value;
            // Update the Booking model and the displayed duration
            Booking.TreatmentId = value;
            UpdateDurationFromTreatment(value);
        }
    }

    // Backing field and property to run logic when employee selection changes
    private int selectedEmployeeId;
    private int SelectedEmployeeId
    {
        get => selectedEmployeeId;
        set
        {
            if (selectedEmployeeId == value) return;
            selectedEmployeeId = value;
            Booking.EmployeeId = value;
            // Recompute price using current treatment/duration + employee
            UpdatePrice();
        }
    }

    // Manual tier discount selection removed; discounts are applied automatically based on usage tiers

    protected override async Task OnInitializedAsync()
    {
        try
        {
            treatments = (await TreatmentService.GetAllAsync()).OrderBy(t => t.Name).ToList();
            customers = (await CustomerService.GetAllAsync()).OrderBy(c => c.FirstName).ToList();
            employees = (await EmployeeService.GetAllAsync()).OrderBy(e => e.LastName).ToList();

            // Initialize event discount defaults
            eventStartDate = DateTime.Today;
            eventEndDate = DateTime.Today;
            eventStartTimeString = "00:00";
            eventEndTimeString = "23:59";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Load failed: {ex.Message}";
        }
    }

    private void OnInvalidSubmit(EditContext ctx)
    {
        ErrorMessage = "Form is invalid. Please fix validation errors.";
    }

    private async Task AddBooking()
    {
        ErrorMessage = null;

        // Parse the time string to TimeOnly
        if (!TimeOnly.TryParse(bookingStartTimeString, out var startTime))
        {
            ErrorMessage = "Ugyldigt starttidspunkt.";
            return;
        }
        Booking.BookingStartTime = startTime;

        // Use the Booking.BookingDuration directly (BookingDurationString is kept for compatibility)
        if (Booking.BookingDuration == default || Booking.BookingDuration <= TimeSpan.Zero)
        {
            // fallback: attempt to parse textual representation
            if (!TimeSpan.TryParse(BookingDurationString, out var duration))
            {
                ErrorMessage = "Ugyldig varighed.";
                return;
            }
            Booking.BookingDuration = duration;
        }
        var (IsValid, ValidationError) = BookingService.ValidateBooking(Booking);
         if (!IsValid)
            {
                ErrorMessage = ValidationError;
                return;
            }


        var canCreate = await BookingService.CanCreateBookingAsync(Booking);
        if (!canCreate)
        {
            ErrorMessage = "Booking conflict: selected customer or employee already has a booking during this time.";
            return;
        }

        try
        {
            await BookingService.AddBookingAsync(Booking);
            NavigationManager.NavigateTo("/bookings");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Save failed: {ex.Message}";
        }

    }

    // Sets the duration to the treatment duration (avoids accumulating on repeated selection)
    private void UpdateDurationFromTreatment(int treatmentId)
    {
        var treatment = treatments?.FirstOrDefault(t => t.Id == treatmentId);
        BookingService.UpdateDurationFromTreatment(Booking, treatment);

        BookingDurationString = Booking.BookingDuration.ToString(@"hh\:mm");
        UpdatePrice();
        StateHasChanged();
    }

    // Compute the price using the most appropriate source:
    // - Use Treatment.Price as base when available
    // - Always add an employee hourly component if an employee + duration are present
    // - Otherwise fall back to employee-only calculation or 0
    private void UpdatePrice()
    {
        var employee = employees?.FirstOrDefault(e => e.Id == Booking.EmployeeId);
        var treatment = treatments?.FirstOrDefault(t => t.Id == Booking.TreatmentId);
        var customer = customers?.FirstOrDefault(c => c.Id == Booking.CustomerId);

        var basePrice = BookingService.CalculatePrice(Booking, employee, treatment, customer);

        // Apply automatic tier discount based on how many times the customer has booked in total (all treatments)
        IDiscountStrategy? autoTierStrategy = null;
        if (customer != null)
        {
            autoTierStrategy = BookingService.GetDiscountStrategyForCustomerTotalBookings(customer);
        }
        var priceWithTier = autoTierStrategy != null ? autoTierStrategy.Apply(basePrice) : basePrice;

        // Apply event discount if applicable and choose the better SINGLE discount (no stacking)
        var (evtApplicable, evtStrategy) = BuildEventDiscountIfApplicable();
        decimal finalPrice;
        if (evtApplicable && evtStrategy != null)
        {
            var priceWithEvent = evtStrategy.Apply(basePrice);
            finalPrice = Math.Min(priceWithTier, priceWithEvent);
        }
        else
        {
            finalPrice = priceWithTier;
        }

        Booking.TotalPrice = Math.Max(0m, decimal.Round(finalPrice, 2));

        StateHasChanged();
    }

    // Event discount state and helpers
    private bool eventDiscountEnabled = false;
    private DateTime? eventStartDate;
    private DateTime? eventEndDate;
    private string eventStartTimeString = "";
    private string eventEndTimeString = "";
    private int? eventDiscountPercent;
    private string? eventValidationMessage;

    private (bool Applicable, IDiscountStrategy? Strategy) BuildEventDiscountIfApplicable()
    {
        eventValidationMessage = null;
        if (!eventDiscountEnabled)
        {
            return (false, null);
        }

        if (eventDiscountPercent is null or < 0 or > 100)
        {
            eventValidationMessage = "Ugyldig event rabatprocent (0-100).";
            return (false, null);
        }

        if (eventStartDate is null || eventEndDate is null)
        {
            eventValidationMessage = "Start- og slutdato skal udfyldes.";
            return (false, null);
        }

        if (!TimeOnly.TryParse(string.IsNullOrWhiteSpace(eventStartTimeString) ? "00:00" : eventStartTimeString, out var evtStartTime))
        {
            eventValidationMessage = "Ugyldig starttid for event.";
            return (false, null);
        }
        if (!TimeOnly.TryParse(string.IsNullOrWhiteSpace(eventEndTimeString) ? "23:59" : eventEndTimeString, out var evtEndTime))
        {
            eventValidationMessage = "Ugyldig sluttid for event.";
            return (false, null);
        }

        var evtStart = eventStartDate.Value.Date.Add(evtStartTime.ToTimeSpan());
        var evtEnd = eventEndDate.Value.Date.Add(evtEndTime.ToTimeSpan());
        if (evtEnd < evtStart)
        {
            eventValidationMessage = "Event slut skal være efter start.";
            return (false, null);
        }

        // Determine the booking's start DateTime
        var bookingStart = Booking.BookingDate.Date.Add(Booking.BookingStartTime.ToTimeSpan());

        var within = bookingStart >= evtStart && bookingStart <= evtEnd;
        if (!within)
        {
            return (false, null);
        }

        var percentage = (decimal)eventDiscountPercent!.Value / 100m;
        return (true, new EventDiscount(percentage));
    }


    // Display helper for the Booking duration (shows hh:mm, including 00:00)
    private string DurationDisplay =>
        Booking.BookingDuration >= TimeSpan.Zero
            ? Booking.BookingDuration.ToString(@"hh\:mm")
            : string.Empty;

    // Display helper for the Booking price (shows currency, including 0 kr)
    private string PriceDisplay =>
        Booking.TotalPrice >= 0m
            ? Booking.TotalPrice.ToString("C0", CultureInfo.GetCultureInfo("da-DK"))
            : string.Empty;
}
