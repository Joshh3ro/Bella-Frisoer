@page "/bookings/opret"
@using BellaFrisoer.Application.Interfaces
@using BellaFrisoer.Domain.Models
@using BellaFrisoer.Domain.Models.Discounts
@using BellaFrisoer.Application.DTOs;
@inject IBookingService BookingService
@inject IBookingPriceService BookingPriceService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject ITreatmentService TreatmentService
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<PageTitle>Opret Booking</PageTitle>

<h1>Opret Booking</h1>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (customers == null || employees == null || treatments == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm Model="this" OnValidSubmit="AddBooking">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Dato</label>
            <InputDate @bind-Value="bookingDate" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Starttidspunkt</label>
            <InputText @bind-Value="BookingStartTimeString" type="time" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Kunde</label>
            @if (!customers.Any())
            {
                <p>Ingen kunder endnu... <a href="/kunder/opret">Opret Kunde</a></p>
            }
            else
            {
                <InputSelect @bind-Value="selectedCustomerId" class="form-select" @onchange="OnCustomerChanged">
                    <option value="0">-- Vælg Kunde --</option>
                    @foreach (var c in customers)
                    {
                        <option value="@c.Id">@c.FirstName @c.LastName (@(c.Bookings?.Count ?? 0) bookings)</option>
                    }
                </InputSelect>
            }
        </div>

        <div class="mb-3">
            <label class="form-label">Ansat</label>
            <InputSelect @bind-Value="SelectedEmployeeId" class="form-select">
                <option value="0">-- Vælg Ansat --</option>
                @foreach (var e in employees)
                {
                    <option value="@e.Id">@e.FirstName @e.LastName</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Behandling</label>
            <InputSelect @bind-Value="SelectedTreatmentId" class="form-select">
                <option value="0">-- Vælg Behandling --</option>
                @foreach (var t in treatments)
                {
                    <option value="@t.Id">@t.Name (@t.Duration min)</option>
                }
            </InputSelect>
        </div>

        <div class="card mb-3">
            <div class="card-header">Eventrabat</div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="eventEnabledSwitch" @bind="EventEnabled" @bind:after="UpdatePrice" />
                    <label class="form-check-label" for="eventEnabledSwitch">Aktivér eventrabat for denne booking</label>
                </div>

                @if (EventEnabled)
                {
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label class="form-label">Startdato</label>
                            <InputDate @bind-Value="EventStartDate" class="form-control" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Starttid</label>
                            <InputText @bind-Value="EventStartTimeString" type="time" class="form-control" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Slutdato</label>
                            <InputDate @bind-Value="EventEndDate" class="form-control"/>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Sluttid</label>
                            <InputText @bind-Value="EventEndTimeString" type="time" class="form-control" />
                        </div>
                    </div>
                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label class="form-label">Procent (%)</label>
                            <InputNumber @bind-Value="EventPercent" class="form-control" />
                        </div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(EventValidationMessage))
                    {
                        <div class="text-danger">@EventValidationMessage</div>
                    }
                }
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Pris</label>
            <span class="badge bg-info">@PriceDisplay</span>
        </div>

        <button type="submit" class="btn btn-primary" disabled="@(!customers.Any())">Opret Booking</button>
        <a href="/bookings" class="btn btn-secondary ms-2">Tilbage</a>
    </EditForm>
}

@code {
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Treatment> treatments = new();
    private DateTime bookingDate = DateTime.Now;
    private string BookingStartTimeString = "";
    private string? ErrorMessage;

    // Event discount state (per booking)
    private bool EventEnabled = false;
    private DateTime? EventStartDate;
    private DateTime? EventEndDate;
    private string EventStartTimeString = "";
    private string EventEndTimeString = "";
    private decimal? EventPercent;
    private string? EventValidationMessage;

    private int selectedCustomerId;
    private int selectedEmployeeId;
    private int selectedTreatmentId;
    private decimal totalPrice;

    private int SelectedEmployeeId
    {
        get => selectedEmployeeId;
        set
        {
            selectedEmployeeId = value;
            UpdatePrice();
        }
    }

    private int SelectedTreatmentId
    {
        get => selectedTreatmentId;
        set
        {
            selectedTreatmentId = value;
            UpdatePrice();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        customers = (await CustomerService.GetAllAsync()).OrderBy(c => c.FirstName).ToList();
        employees = (await EmployeeService.GetAllAsync()).OrderBy(e => e.LastName).ToList();
        treatments = (await TreatmentService.GetAllAsync()).OrderBy(t => t.Name).ToList();
    }

    private async Task OnCustomerChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            selectedCustomerId = id;
        }
        await UpdatePrice();
    }

    private async Task UpdatePrice()
    {
        var employee = employees.FirstOrDefault(e => e.Id == selectedEmployeeId);
        var treatment = treatments.FirstOrDefault(t => t.Id == selectedTreatmentId);
        var customer = customers.FirstOrDefault(c => c.Id == selectedCustomerId);

        if (employee == null || treatment == null || customer == null || !TimeOnly.TryParse(BookingStartTimeString, out var startTime))
        {
            totalPrice = 0;
            StateHasChanged();
            return;
        }

        // Opret en midlertidig booking til prisberegning
        var tempBooking = Booking.Create(customer, employee, treatment, bookingDate, startTime);

        // Parse event time inputs
        TimeOnly? eventStartTime = TimeOnly.TryParse(EventStartTimeString, out var est) ? est : null;
        TimeOnly? eventEndTime = TimeOnly.TryParse(EventEndTimeString, out var eet) ? eet : null;

        // Validate event inputs
        EventValidationMessage = null;
        if (EventEnabled)
        {
            if (EventPercent is null || EventPercent < 0m || EventPercent > 100m)
            {
                EventValidationMessage = "Procent skal være mellem 0 og 100.";
            }
            else if (EventStartDate is null || EventEndDate is null)
            {
                EventValidationMessage = "Start- og slutdato er påkrævet.";
            }
            else if (!TimeOnly.TryParse(EventStartTimeString, out _) || !TimeOnly.TryParse(EventEndTimeString, out _))
            {
                EventValidationMessage = "Ugyldigt tidspunkt for event.";
            }
        }

        var basePriceTask = Task.Run(() =>
            BookingPriceService.CalculateFinalPrice(
                tempBooking,
                employee,
                treatment,
                customer,
                false, // EventEnabled
                null,  // EventStartDate
                null,  // EventEndDate
                null,  // eventStartTime
                null,  // eventEndTime
                null   // EventPercent
            )
        );

        var eventDiscountTask = EventEnabled
            ? Task.Run(() =>
                BookingPriceService.CalculateFinalPrice(
                    tempBooking,
                    employee,
                    treatment,
                    customer,
                    EventEnabled,
                    EventStartDate,
                    EventEndDate,
                    eventStartTime,
                    eventEndTime,
                    EventPercent
                )
            )
            : Task.FromResult(decimal.Zero);

        var tierDiscountTask = customer != null
            ? Task.Run(() =>
            {
                var tierDiscount = BookingService.GetDiscountStrategyForCustomerTotalBookings(customer);
                return tierDiscount?.Apply(
                    BookingPriceService.CalculateFinalPrice(
                        tempBooking,
                        employee,
                        treatment,
                        customer,
                        false,  // EventEnabled
                        null,   // EventStartDate
                        null,   // EventEndDate
                        null,   // eventStartTime
                        null,   // eventEndTime
                        null    // EventPercent
                    )
                ) ?? decimal.Zero;
            })
            : Task.FromResult(decimal.Zero);

        await Task.WhenAll(basePriceTask, eventDiscountTask, tierDiscountTask);

        var basePrice = basePriceTask.Result;
        var eventDiscountPrice = eventDiscountTask.Result;
        var tierDiscountPrice = tierDiscountTask.Result;

        var prices = new[] { basePrice, eventDiscountPrice, tierDiscountPrice };
        var validPrices = prices.Where(p => p > 0).ToArray();
        totalPrice = validPrices.Any() ? validPrices.Min() : 0;

        StateHasChanged();
    }

    private string DurationDisplay
    {
        get
        {
            var treatment = treatments.FirstOrDefault(t => t.Id == selectedTreatmentId);
            return treatment != null ? TimeSpan.FromMinutes(treatment.Duration).ToString(@"hh\:mm") : "00:00";
        }
    }
    private string PriceDisplay => totalPrice.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("da-DK"));

    private async Task AddBooking()
    {
        ErrorMessage = null;

        if (!TimeOnly.TryParse(BookingStartTimeString, out var startTime))
        {
            ErrorMessage = "Ugyldigt starttidspunkt.";
            return;
        }

        if (selectedCustomerId == 0 || selectedEmployeeId == 0 || selectedTreatmentId == 0)
        {
            ErrorMessage = "Vælg venligst kunde, ansat og behandling.";
            return;
        }

		// Lightweight dto der skal sendes bruges til oprettelse af booking
        var dto = new BookingCreateDto
        {
            CustomerId = selectedCustomerId,
            EmployeeId = selectedEmployeeId,
            TreatmentId = selectedTreatmentId,
            BookingDate = bookingDate.Date,
            BookingStartTime = startTime,
            
            // Udregnes i constructor
            //BasePrice = totalPrice
        };

        try
        {
            await BookingService.AddBookingAsync(dto);
            NavigationManager.NavigateTo("/bookings");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Gem fejlede: {ex.Message}";
        }
    }
}
