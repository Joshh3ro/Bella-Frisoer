@page "/bookings/edit"
@using Microsoft.EntityFrameworkCore
@using BellaFrisoer.Domain.Models
@inject IDbContextFactory<BellaFrisoer.Infrastructure.Data.BellaFrisoerWebUiContext> DbFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Edit</PageTitle>

<h1>Edit</h1>

<h2>Booking</h2>
<hr />
@if (Booking is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-4">
            <EditForm method="post" Model="@Booking" OnValidSubmit="UpdateBooking" FormName="edit" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary role="alert" />

                @* Skjult Id (egentlig ikke strengt nødvendigt, Booking-objektet er jo allerede i memory) *@
                <input type="hidden" name="Booking.Id" value="@Booking.Id" />

                <div class="mb-3">
                    <label for="BookingDate" class="form-label">BookingDate:</label>
                    <InputDate id="BookingDate" @bind-Value="Booking.BookingDate" class="form-control" />
                    <ValidationMessage For="@(() => Booking.BookingDate)" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="CustomerName" class="form-label">Customer Name:</label>
                    <InputText id="CustomerName" @bind-Value="Booking.Customer.Name" class="form-control" />
                    <ValidationMessage For="@(() => Booking.Customer.Name)" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="CustomerPhone" class="form-label">Customer Phone:</label>
                    <InputNumber id="CustomerPhone" @bind-Value="Booking.Customer.PhoneNumber" class="form-control" />
                    <ValidationMessage For="@(() => Booking.Customer.PhoneNumber)" class="text-danger" />
                </div>

                <button type="submit" class="btn btn-primary">Save</button>
            </EditForm>
        </div>
    </div>
}

<div>
    <a href="/bookings">Back to List</a>
</div>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Booking? Booking { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // Hent booking inkl. Customer, så Booking.Customer.Name ikke er null
        Booking = await context.Bookings
                               .Include(b => b.Customer)
                               .FirstOrDefaultAsync(m => m.Id == Id);

        if (Booking is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateBooking()
    {
        using var context = DbFactory.CreateDbContext();

        // Load tracked booking including customer so EF can detect changes on related entity
        var tracked = await context.Bookings
                                   .Include(b => b.Customer)
                                   .FirstOrDefaultAsync(b => b.Id == Booking!.Id);

        if (tracked is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        // Update booking scalar properties that should change
        tracked.BookingDate = Booking.BookingDate;

        // Update related customer's editable fields and mark them modified
        if (tracked.Customer is null)
        {
            if (Booking.Customer is not null)
            {
                // Attach new/detached customer and set value
                tracked.Customer = Booking.Customer;
                context.Attach(tracked.Customer);
                context.Entry(tracked.Customer).Property(c => c.Name).IsModified = true;
                context.Entry(tracked.Customer).Property(c => c.PhoneNumber).IsModified = true;
            }
        }
        else
        {
            tracked.Customer.Name = Booking.Customer?.Name ?? tracked.Customer.Name;
            tracked.Customer.PhoneNumber = Booking.Customer?.PhoneNumber ?? tracked.Customer.PhoneNumber;
            context.Entry(tracked.Customer).Property(c => c.Name).IsModified = true;
            context.Entry(tracked.Customer).Property(c => c.PhoneNumber).IsModified = true;
        }

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!BookingExists(tracked.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/bookings");
    }

    private bool BookingExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Bookings.Any(e => e.Id == id);
    }
}
