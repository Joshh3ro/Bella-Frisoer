@page "/bookings/rediger"
@using BellaFrisoer.Application.Interfaces
@using BellaFrisoer.Application.Queries
@using BellaFrisoer.Domain.Models
@using BellaFrisoer.Application.DTOs
@inject IBookingService BookingService
@inject IBookingQuery BookingQuery
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject ITreatmentService TreatmentService
@inject IBookingPriceService PriceService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Redigér Booking</PageTitle>

<h1>Redigér Booking</h1>

@if (Booking is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm Model="this" OnValidSubmit="UpdateBooking" FormName="editBooking">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Dato:</label>
            <InputDate @bind-Value="bookingDate" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Kunde:</label>
            <InputSelect @bind-Value="selectedCustomerId" class="form-select">
                <option value="0">-- Vælg Kunde --</option>
                @foreach (var c in customers)
                {
                    <option value="@c.Id">@c.FirstName @c.LastName</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Ansat:</label>
            <InputSelect @bind-Value="selectedEmployeeId" class="form-select">
                <option value="0">-- Vælg Ansat --</option>
                @foreach (var e in employees)
                {
                    <option value="@e.Id">@e.FirstName @e.LastName</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Behandling:</label>
            <InputSelect @bind-Value="selectedTreatmentId" class="form-select">
                <option value="0">-- Vælg behandling --</option>
                @foreach (var t in treatments)
                {
                    <option value="@t.Id">@t.Name (@t.Duration min)</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Pris:</label>
            <div>@totalPrice.ToString("C0", daDK)</div>
        </div>

        <button type="submit" class="btn btn-primary">Gem</button>
        <a href="/bookings" class="btn btn-secondary ms-2">Tilbage</a>
    </EditForm>
}

@code {
    private static readonly System.Globalization.CultureInfo daDK =
        System.Globalization.CultureInfo.GetCultureInfo("da-DK");

    [SupplyParameterFromQuery] private int Id { get; set; }

    private Booking? Booking { get; set; }
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Treatment> treatments = new();

    private int selectedCustomerId;
    private int selectedEmployeeId;
    private int selectedTreatmentId;
    private DateTime bookingDate;
    private decimal totalPrice;

    protected override async Task OnInitializedAsync()
    {
        Booking = await BookingQuery.GetByIdAsync(Id, default);
        if (Booking is null)
        {
            NavigationManager.NavigateTo("/notfound");
            return;
        }

        customers = (await CustomerService.GetAllAsync()).ToList();
        employees = (await EmployeeService.GetAllAsync()).ToList();
        treatments = (await TreatmentService.GetAllAsync()).ToList();

        selectedCustomerId = Booking.Customer.Id;
        selectedEmployeeId = Booking.Employee.Id;
        selectedTreatmentId = Booking.Treatment.Id;
        bookingDate = Booking.BookingDate;

        await UpdatePrice();
    }

    private async Task UpdatePrice()
    {
        var customer = customers.FirstOrDefault(c => c.Id == selectedCustomerId);
        var employee = employees.FirstOrDefault(e => e.Id == selectedEmployeeId);
        var treatment = treatments.FirstOrDefault(t => t.Id == selectedTreatmentId);

        if (customer == null || employee == null || treatment == null)
        {
            totalPrice = 0;
            return;
        }

        var dto = new UpdatePriceDto
        {
            CustomerId = customer.Id,
            EmployeeId = employee.Id,
            TreatmentId = treatment.Id,
            BookingDate = bookingDate,
            BookingStartTime = Booking!.BookingStartTime
        };

        totalPrice = await PriceService.CalculateFinalPrice(dto, customer, employee, treatment);
        StateHasChanged();
    }

    private async Task UpdateBooking()
    {
        if (Booking == null)
            return;

        var dto = new BookingUpdateDto
        {
            Id = Booking.Id,
            CustomerId = selectedCustomerId,
            EmployeeId = selectedEmployeeId,
            TreatmentId = selectedTreatmentId,
            BookingDate = bookingDate,
            BookingStartTime = Booking.BookingStartTime
        };

        await BookingService.UpdateBookingAsync(dto);
        NavigationManager.NavigateTo("/bookings");
    }
}
