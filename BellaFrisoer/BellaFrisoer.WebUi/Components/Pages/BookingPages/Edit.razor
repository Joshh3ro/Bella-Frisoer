@page "/bookings/rediger"
@using BellaFrisoer.Application.Interfaces
@using BellaFrisoer.Domain.Models
@inject IBookingService BookingService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject ITreatmentService TreatmentService
@inject NavigationManager NavigationManager

<PageTitle>Redigér Booking</PageTitle>

<h1>Redigér Booking</h1>

@if (Booking is null || customers is null || employees is null || treatments is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm Model="this" OnValidSubmit="UpdateBooking">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Dato:</label>
            <InputDate @bind-Value="bookingDate" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Kunde:</label>
            <InputSelect @bind-Value="selectedCustomerId" class="form-select">
                <option value="0">-- Vælg Kunde --</option>
                @foreach (var c in customers)
                {
                    <option value="@c.Id">@c.FirstName @c.LastName (@(c.Bookings?.Count ?? 0) bookings)</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Ansat:</label>
            <InputSelect @bind-Value="SelectedEmployeeId" class="form-select">
                <option value="0">-- Vælg Ansat --</option>
                @foreach (var e in employees)
                {
                    <option value="@e.Id">@e.FirstName @e.LastName</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Behandling:</label>
            <InputSelect @bind-Value="SelectedTreatmentId" class="form-select">
                <option value="0">-- Vælg behandling --</option>
                @foreach (var t in treatments)
                {
                    <option value="@t.Id">@t.Name (@t.Duration min)</option>
                }
            </InputSelect>
        </div>

        <dl class="row">
            <dt class="col-sm-2">Pris</dt>
            <dd class="col-sm-10">@totalPrice.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("da-DK"))</dd>
        </dl>

        <div class="mb-3">
            <label class="form-label">Rabat:</label>
            <span class="badge bg-info">@GetDiscountLabel()</span>
        </div>

        <button type="submit" class="btn btn-primary">Gem</button>
        <a href="/bookings" class="btn btn-secondary ms-2">Tilbage</a>
    </EditForm>
}

@code {
    [SupplyParameterFromQuery] private int Id { get; set; }
    private Booking? Booking { get; set; }
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Treatment> treatments = new();

    private int selectedCustomerId;
    private int selectedEmployeeId;
    private int selectedTreatmentId;
    private DateTime bookingDate;
    private decimal totalPrice;

    private int SelectedEmployeeId
    {
        get => selectedEmployeeId;
        set
        {
            selectedEmployeeId = value;
            UpdatePrice();
        }
    }

    private int SelectedTreatmentId
    {
        get => selectedTreatmentId;
        set
        {
            selectedTreatmentId = value;
            UpdatePrice();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Booking = await BookingService.GetByIdAsync(Id);
        if (Booking is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        customers = (await CustomerService.GetAllAsync()).OrderBy(c => c.FirstName).ToList();
        employees = (await EmployeeService.GetAllAsync()).OrderBy(e => e.LastName).ToList();
        treatments = (await TreatmentService.GetAllAsync()).OrderBy(t => t.Name).ToList();

        selectedCustomerId = Booking.Customer?.Id ?? 0;
        selectedEmployeeId = Booking.Employee?.Id ?? 0;
        selectedTreatmentId = Booking.Treatment?.Id ?? 0;
        bookingDate = Booking.BookingDate;

        UpdatePrice();
    }

    private void UpdatePrice()
    {
        var employee = employees.FirstOrDefault(e => e.Id == selectedEmployeeId);
        var treatment = treatments.FirstOrDefault(t => t.Id == selectedTreatmentId);
        var customer = customers.FirstOrDefault(c => c.Id == selectedCustomerId);

        if (employee != null && treatment != null && customer != null)
        {
            // Vi bruger en midlertidig booking til prisberegning
            var tempBooking = Booking.Create(customer, employee, treatment, bookingDate, Booking!.BookingStartTime);
            totalPrice = BookingService.CalculatePrice(tempBooking, employee, treatment, customer);
        }
    }

    private string GetDiscountLabel()
    {
        var count = customers.FirstOrDefault(c => c.Id == selectedCustomerId)?.Bookings?.Count ?? 0;
        if (count >= 15) return "Guld (15%)";
        if (count >= 10) return "Sølv (10%)";
        if (count >= 5) return "Bronze (5%)";
        return "Ingen rabat";
    }

    private async Task UpdateBooking()
    {
        if (Booking == null) return;

        var customer = customers.First(c => c.Id == selectedCustomerId);
        var employee = employees.First(e => e.Id == selectedEmployeeId);
        var treatment = treatments.First(t => t.Id == selectedTreatmentId);

        // Da vi ikke kan ændre Booking objektet direkte pga. protected setters,
        // og vi skal bevare ID'et, bruger vi reflection som en nødvendig løsning i WebUI
        // for at overholde reglen om ikke at ændre Domain.
        SetProperty(Booking, nameof(Booking.Customer), customer);
        SetProperty(Booking, nameof(Booking.Employee), employee);
        SetProperty(Booking, nameof(Booking.Treatment), treatment);
        SetProperty(Booking, nameof(Booking.BookingDate), bookingDate.Date);
        SetProperty(Booking, "BasePrice", totalPrice);

        await BookingService.UpdateBookingAsync(Booking);
        NavigationManager.NavigateTo("/bookings");
    }

    private void SetProperty(object obj, string propertyName, object value)
    {
        var prop = obj.GetType().GetProperty(propertyName, System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        if (prop != null && prop.CanWrite)
        {
            prop.SetValue(obj, value);
        }
        else if (prop != null)
        {
            // Prøv backing field hvis property setter er utilgængelig
            var field = obj.GetType().GetField($"<{propertyName}>k__BackingField", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            field?.SetValue(obj, value);
        }
    }
}
