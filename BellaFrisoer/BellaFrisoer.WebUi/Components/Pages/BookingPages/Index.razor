@page "/bookings"
@using Microsoft.EntityFrameworkCore
@using BellaFrisoer.Application.Interfaces
@using BellaFrisoer.Application.Queries
@inject IBookingService BookingService
@inject IBookingQuery BookingQuery

<PageTitle>Bookings</PageTitle>

<h1>Bookings</h1>

<p>
    <a class="btn btn-primary" href="/bookings/opret">Opret Booking</a>
</p>
<input @oninput="OnSearchChanged" class="form-control mb-3" placeholder="Søg Bookings..." />

@if (bookings is null)
{
	<p><em>Loading...</em></p>
}
else if (!bookings.Any())
{
	<p>Ingen bookings endnu...</p>
}
else
{
	<table class="table table-striped table-hover">
		<thead>
			<tr>
				<th>Ansatte</th>
				<th>Kunde</th>
				<th>Dato/Tidspunkt</th>
				<th>Varighed (minutter)</th>
				<th>Slut tid</th>
				<th>Behandslingtype</th>
				<th>Total Pris</th>

				<th></th>
			</tr>
		</thead>
		<tbody>
			@foreach (var b in bookings)
			{
				<tr>
					<td>@(b.Employee?.FirstName ?? "—")</td>
					<td>@(b.Customer?.FirstName ?? "-")</td>
					<td>@b.BookingDate.Add(b.BookingStartTime.ToTimeSpan()).ToString()</td>
					<td>@b.BookingDuration.TotalMinutes</td>
					<td>@b.BookingDate.Add(b.BookingStartTime.ToTimeSpan()).Add(b.BookingDuration).ToString()</td>
					<td>@(b.Treatment?.Name ?? "-")</td>
					<td>@b.BasePrice.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("da-DK"))</td>

					<td>
						<a href="/invoice/@b.Id" class="btn btn-sm btn-success">Download Faktura</a>
						<a href="/bookings/detaljer?id=@b.Id" class="btn btn-sm btn-primary">Detaljer</a>
						<a href="/bookings/rediger?id=@b.Id" class="btn btn-sm btn-warning">Rediger</a>
						<a href="/bookings/slet?id=@b.Id" class="btn btn-sm btn-danger">Slet</a>
					</td>
				</tr>
			}
		</tbody>
	</table>
}

@code {
	private IReadOnlyList<Booking> bookings;

	protected override async Task OnInitializedAsync()
	{
		bookings = await BookingQuery.GetAllAsync(cancellationToken: default);
	}
	private async Task OnSearchChanged(ChangeEventArgs e)
	{
		string searchString = e.Value?.ToString() ?? string.Empty;
		bookings = await BookingQuery.FilterBookingsAsync(searchString, cancellationToken: default);
	}
}
