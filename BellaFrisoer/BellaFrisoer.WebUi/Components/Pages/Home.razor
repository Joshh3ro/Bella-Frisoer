@page "/"
@using BellaFrisoer.Application.Interfaces
@using BellaFrisoer.Domain.Models
@rendermode InteractiveServer

@inject IBookingService BookingService
@inject IEmployeeService EmployeeService

<PageTitle>Kalender</PageTitle>

<EditForm Model="@this">
    <InputDate @bind-Value="myDate" />
</EditForm>

<select @bind="SelectedEmployeeId">
    <option value="">-- Alle Ansatte --</option>
    @foreach (var e in Employees)
    {
        <option value="@e.Id">@e.FirstName</option>
    }
</select>

<button @onclick="SortBookings">Sortér Bookings</button>

@if (SortedBookings.Any())
{
    @foreach (var b in SortedBookings)
    {
        <p>@b.Customer?.FirstName Har en tid hos @b.Employee?.FirstName kl. @b.BookingDateTime</p>
    }
}

@code
{
    public DateTime myDate = DateTime.Today;

    public int? SelectedEmployeeId { get; set; }

    public List<Employee> Employees { get; set; } = new();
    public List<Booking> SortedBookings { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        Employees = (await EmployeeService.GetAllAsync()).OrderBy(e => e.FirstName).ToList();
        await SortBookings();
    }

    private async Task SortBookings()
    {
        var allBookings = await BookingService.GetAllAsync();

        var filtered = allBookings.Where(b => b.BookingDate.Date == myDate.Date);

        if (SelectedEmployeeId.HasValue)
        {
            filtered = filtered.Where(b => b.EmployeeId == SelectedEmployeeId.Value);
        }

        SortedBookings = filtered.OrderBy(b => b.BookingDate).ToList();
    }
}
