@page "/"
@using BellaFrisoer.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer

@inject BellaFrisoerWebUiContext Db

<PageTitle>Kalender</PageTitle>

<EditForm Model="@this">
    <label for="datePicker" class="form-label">Vælg dato</label>
    <InputDate id="datePicker" @bind-Value="myDate" class="form-control" />
</EditForm>

<select @bind="SelectedEmployeeId" class="form-select my-2">
    <option value="">-- Alle ansatte --</option>

    @foreach (var emp in Employees)
    {
        <option value="@emp.Id">@emp.Name</option>
    }
</select>

<button class="btn btn-primary" @onclick="SortBookings">Sortér bookinger</button>

@if (SortedBookings.Any())
{
    @foreach (Booking b in SortedBookings)
    {
        <p>@(b.Customer?.Name ?? "Ukendt kunde") har en tid hos @(b.Employee?.Name ?? "Ukendt ansat") kl. @b.BookingDate.ToString("HH:mm")</p>
    }
}

@code
{
	public DateTime myDate = DateTime.Today;

	public int? SelectedEmployeeId { get; set; }

	public List<Employee> Employees { get; set; } = new();
	public List<Booking> SortedBookings { get; set; } = new();

	protected override async Task OnInitializedAsync()
	{
		Employees = await Db.Employees.OrderBy(e => e.Name).ToListAsync();
	}

	private async Task SortBookings()
	{
		var query = Db.Bookings
			.Include(b => b.Customer)
			.Include(b => b.Employee)
			.Where(b => b.BookingDate.Date == myDate.Date);

		if (SelectedEmployeeId.HasValue)
		{
			query = query.Where(b => b.EmployeeId == SelectedEmployeeId.Value);
		}

		SortedBookings = await query
			.OrderBy(b => b.BookingDate)
			.ToListAsync();
	}
}