@page "/kunder/detaljer"
@using BellaFrisoer.Application.Interfaces
@using Microsoft.EntityFrameworkCore
@using BellaFrisoer.Domain.Models
@inject NavigationManager NavigationManager
@inject ICustomerService CustomerService
@rendermode InteractiveServer

<PageTitle>Detaljer</PageTitle>

<h1>Detaljer</h1>

<div>
    <h2>Kunde Information</h2>
    <hr />
    @if (customer == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <dl class="row">
            <dt class="col-sm-2">Fornavn:</dt>
            <dd class="col-sm-10">@customer.FirstName</dd>

            <dt class="col-sm-2">Efternavn:</dt>
            <dd class="col-sm-10">@customer.LastName</dd>

            <dt class="col-sm-2">Telefon Nummer:</dt>
            <dd class="col-sm-10">@customer.PhoneNumber</dd>

            <dt class="col-sm-2">Email:</dt>
            <dd class="col-sm-10">@customer.Email</dd>

            <dt class="col-sm-2">Antal Besøg:</dt>
            <dd class="col-sm-10">@customer.Bookings?.Count</dd>
        </dl>

        <h3>Tidligere Bookings</h3>
        @if (customer.Bookings != null && customer.Bookings.Any())
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Dato</th>
                        <th>Starttidspunkt</th>
                        <th>Varighed</th>
                        <th>Behandling</th>
                        <th>Pris</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var b in customer.Bookings.OrderByDescending(b => b.BookingDate))
                    {
                        <tr>
                            <td>@b.BookingDate.ToShortDateString()</td>
                            <td>@b.BookingStartTime</td>
                            <td>@b.BookingDuration.ToString(@"hh\:mm")</td>
                            <td>@b.Treatment?.Name ?? "–"</td>
                            <td>@b.BasePrice.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("da-DK"))</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p><em>Ingen tidligere bookings</em></p>
        }

        <div class="mt-3">
            <a class="btn btn-primary" href="@($"/kunder/rediger?id={customer.Id}")">Redigér</a>
            <a class="btn btn-danger" href="@($"/kunder/slet?id={customer.Id}")">Slet</a>
            <a class="btn btn-secondary" href="/kunder">Tilbage</a>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Customer? customer;

    protected override async Task OnInitializedAsync()
    {
        // Make sure your service includes Bookings and Treatment in the query
        customer = await CustomerService.GetCustomerByIdAsync(Id);

        if (customer == null)
        {
            NavigationManager.NavigateTo("/kunder");
        }
    }
}
