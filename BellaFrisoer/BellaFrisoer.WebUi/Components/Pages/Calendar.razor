@page "/kalender"
@using BellaFrisoer.Application.Interfaces
@using BellaFrisoer.Domain.Models
@using BellaFrisoer.Application.Queries
@rendermode InteractiveServer
@inject IBookingQuery bookingQuery
@inject IBookingService BookingService
@inject IEmployeeService EmployeeService

<PageTitle>Kalender</PageTitle>

<h1>Kalender</h1>

<div class="row mb-3">
    <div class="col-md-4">
        <label>Dato</label>
        <InputDate @bind-Value="myDate" class="form-control" />
    </div>

    <div class="col-md-4">
        <label>Ansatte</label>
        <select @bind="selectedEmployeeId" class="form-control">
            <option value="">-- Alle Ansatte --</option>
            @foreach (var e in Employees)
            {
                <option value="@e.Id">@e.FirstName</option>
            }
        </select>
    </div>

    <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-primary w-100" @onclick="SortBookings">Sortér Bookings</button>
    </div>
</div>

@if (SortedBookings.Any())
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Medarbejder</th>
                <th>Kunde</th>
                <th>Starttidspunkt</th>
                <th>Varighed</th>
                <th>Behandling</th>
                <th>Pris</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var b in SortedBookings)
            {
                <tr>
                    <td>@b.Employee?.FirstName</td>
                    <td>@b.Customer?.FirstName @b.Customer?.LastName</td>
                    <td>@b.BookingStartTime</td>
                    <td>@b.BookingDuration.ToString(@"hh\:mm")</td>
                    <td>@b.Treatment?.Name</td>
                    <td>@b.TotalPrice.ToString("C0")</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p><em>Ingen tider fundet for denne dato.</em></p>
}

@code
{
    public DateTime myDate = DateTime.Today;

    private int? selectedEmployeeId;

    public List<Employee> Employees { get; set; } = new();
    public List<Booking> SortedBookings { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        Employees = (await EmployeeService.GetAllAsync())
            .OrderBy(e => e.FirstName)
            .ToList();

        await SortBookings();
    }

    private async Task SortBookings()
    {
        var allBookings = await bookingQuery.GetAllAsync(cancellationToken: default);

        var filtered = allBookings.Where(b => b.BookingDate.Date == myDate.Date);

        if (selectedEmployeeId.HasValue && selectedEmployeeId.Value != 0)
        {
            filtered = filtered.Where(b => b.Employee.Id == selectedEmployeeId.Value);
        }

        SortedBookings = filtered
            .OrderBy(b => b.BookingStartTime)
            .ToList();
    }
}
